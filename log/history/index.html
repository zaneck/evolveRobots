<!DOCTYPE html>
<meta charset="utf-8"/>
<head>
        <link rel="stylesheet" type="text/css" href="evolvebot.css"/>
</head>
<body>

<div class='title'>History view</div>
<br>
<hr>
<div class='desc'>
In a single view we display all the candidates that appears during a run of the algorithm. <br>
They are ordered according to their "birthdate". <br>
The color is representing the generation. It is possible to visualize the parent of a candidate by 
putting the mouse over. <br>
Green links are for appending on new shape to a candidate.  Red for deleting one shape to a candidate. 
CrossOver is represented with a yellow link. Blue color is for the other parent :) 

<br>
</div>
<hr>
<script src="tools.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
d3.csv("history.csv", function(dataset) {
        var posdatax={}
        var posdatay={}
        var colorset = {}
        var gensize = {}
        var genbegin = {}
        var genarray = []
        var links = []
        dataset.forEach(function(d) {
                colorset[d.gen] = randomColor() 
                genbegin[d.gen] = 1000000000
                if(d.gen in gensize){
                        gensize[d.gen] = 0
                        genarray[d.gen] += 1 
                }else{
                        gensize[d.gen] = 0
                        genarray.push(1) 
                }
                if(d.a!='None'){
                        console.log("PUSH: "+d.id+"->"+d.a)
                        links.push({"src":d.id, "tgt":d.a, "type":d.type})
                        if(d.b!='None')
                                links.push({"src":d.id, "tgt":d.b, "type":d.type})
                }
        })
        var boxw = 50;
        var boxh = 20;
        var h = 500;
        
        var svgleft = d3.select("body")
                        .append("svg")
                        .attr("height", 2048)
                        .attr("style", "float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;")

        var genrects = svgleft.selectAll("rect")
                              .data(genarray)
                              .enter()
                              .append("rect");

        var selectedCandidates = []
                              
        var svg = d3.select("body")
                    .append("svg")
                    .attr("height", 2048)
                    .attr("style", "float: left; width: 93%; margin-right: 1%; margin-bottom: 0.5em;")
                    
        d3.select("body")
                .append("p")
                .attr("style", "clear: both;")

        var rects = svg.selectAll("rect")
                .data(dataset)
                .enter()
                .append("rect");
    
        rects.attr("x",    function(d,i){ 
                        var val = (i%30)*(boxw+1)
                        posdatax[d.id] = val 
                        return val }
                    )
                .attr("y", function(d,i){ 
                        var val = Math.floor((i/30))*(boxh+10)
                        if(val>gensize[d.gen]){
                                gensize[d.gen]=val
                        }
                        if(val<genbegin[d.gen]){
                                genbegin[d.gen]=val
                        }
                        posdatay[d.id] = val 
                        return val })
                .attr("width", boxw)
                .attr("height", boxh)
                .attr("fill", function(d,i){return colorset[d.gen] }) 
                .on("mouseenter", mouseover)
                .on("mouseleave", mouseout)
                .on("click", mouseclick)
                .attr("id", function(d){return d.id;} )

          genrects.attr("x",    function(d,i){ return 0 })
                .attr("y",      function(d,i){ return genbegin[i]+30 })
                .attr("width", 60)
                .attr("height", function(d,i){ return gensize[i]-genbegin[i]})
                .attr("fill", function(d,i){return colorset[i] }) 
                
          svgleft.selectAll("text")
                .data(genarray)
                .enter()
                .append("text")
                .text(function(d,i) { return i })
                .attr("x", function(d, i) { return 25 ;})
                .attr("y", function(d,i){ return 0.5*(gensize[i]+genbegin[i]+60) })
                .attr("font-family", "sans-serif")
                .attr("font-size", "15px")
                .attr("fill", "white")
                .attr("font-weight", "bold")
                .attr("text-anchor", "middle")
               
                

        svg.selectAll("text")
                .data(dataset)
                .enter()
                .append("text")
                .text(function(d) { return d.id })
                .attr("x", function(d, i) {
                        return (i%30)*(boxw+1) + boxw/2 ;
                })
                .attr("y", function(d,i){ return Math.floor((i/30))*(boxh+10)+15 })
                .attr("font-family", "sans-serif")
                .attr("font-size", "12px")
                .attr("fill", "white")
                .attr("font-weight", "bold")
                .attr("text-anchor", "middle")
                .on("mouseenter", mouseover)
                .on("mouseleave", mouseout)
                .on("click", mouseclick)
                
         /*var link = svg.selectAll(".link")
        .data(links)
        .enter().append("path")
        .attr("class", "link")
        .attr("id",function(d){ return "node-"+d.src+"-"+d.tgt } ) 
        .attr("d", function(d, i) {
                src=d.src
                tgt=d.tgt
                var x = (src%30)*(boxw+1)+boxw/2
                var y = Math.floor((src/30))*(boxh+10)
                var tx = (tgt%30)*(boxw+1)+boxw/2-x
                var ty = Math.floor((tgt/30))*(boxh+10)+boxh-y
                var cx = 0.75*(tx)
                var cy = 0.25*(ty)
                //return "M" + [x,y]
                //        + "L" + [tx,ty];
                return "M" + [x,y]
                        + "q" + [cx, cy, tx,ty];
                
        });*/ 
        var prevs = svg.selectAll("image")
        function makimg(datapath){
                 pp = []
                 prevs.each(function(d,i){
                        pp.push({"x":posdatax[d]-60, "y":posdatay[d]})
                 })
                 
                 var img = svg.selectAll("image")
                                    .data(datapath)
                                    .enter()
                                    .append("image")
                                    .attr("id", function(d){ return "image-"+d; })
                                    .attr("width", 64)
                                    .attr("height", 64)
                                    .style("opacity", 0)
                                    /*.attr("x", function(d,i){ 
                                         //if(i<pp.length)
                                         //       return pp[i].x
                                         //if(i>0)
                                                //return posdatax[d]
                                         return 800 
                                     } )
                                    .attr("y", function(d,i){ 
                                        //if(i<pp.length)
                                        //        return pp[i].y
                                        //if(i>0)
                                        //        return posdatay[d]
                                         return posdatay[d]-60 
                                     } )*/
                                    //.transition()
                                    //.duration(100)
                                    .attr("xlink:href", function(d,i){ return "../generation"+dataset[d].gen+"/candidate"+d+".png"})
                                    .attr("x", function(d,i){ 
                                                if(i>0)
                                                                return posdatax[d]
                                                              return posdatax[d]-60 
                                                               })
                                    .attr("y", function(d,i){ 
                                        return posdatay[d] }
                                        )
                                    .style("opacity",1)
                                    
                      prevs = svg.selectAll("image")
        }
        var selectedLinks = []
        function setLinkState(src, tgt, state,type)
        {
                selectedLinks.push({"src":src, "tgt":tgt, "type":type})
                /*var ids = "#node-" + src + "-" + tgt
                if(state){
                        
                        svg.select(ids)
                              .transition()
                              .duration(0)
                              .style("stroke-opacity", "0.8")
                              .style("stroke-width", "4px")
                              .style("stroke", function(d){
                                  if(type=="A")
                                        return "#0F0";
                                  if(type=="D") 
                                        return "#F00";
                                  if(type=="X")
                                        return "#FF0";
                                  return "#00F";
                                }
                              )
                }else{
                        svg.select(ids)
                              .transition()
                              .duration(0)
                              .style("stroke-opacity", "0.1")
                              .style("stroke-width", "1px")
                              .style("stroke", "#F00")
                }*/

        }
        
        function makLinks(theLinks){
          var link = svg.selectAll("hoverlinks")
                .data(theLinks)
                .enter().append("path")
                .attr("class", "hoverlinks")
                .attr("id",function(d){ return "hoverlinks-"+d.src+"-"+d.tgt } ) 
                .transition()
                .duration(100)
                .style("stroke-opacity", "1.0")
                .style("stroke", function(d){
                                  if(d.type=="A")
                                        return "#0F0";
                                  if(d.type=="D") 
                                        return "#F00";
                                  if(d.type=="X")
                                        return "#FF0";
                                  return "#00F";
                                })
                .attr("d", function(d, i) {
                src=d.src
                tgt=d.tgt
                var x = (src%30)*(boxw+1)+boxw/2
                var y = Math.floor((src/30))*(boxh+10)
                var tx = (tgt%30)*(boxw+1)+boxw/2-x
                var ty = Math.floor((tgt/30))*(boxh+10)+boxh-y
                var cx = 0.75*(tx)
                var cy = 0.25*(ty)
                //return "M" + [x,y]
                //        + "L" + [tx,ty];
                return "M" + [x,y]
                        + "q" + [cx, cy, tx,ty];
                
                });
        }
        
        function changeParent(id,state, path){
                console.log(id+":changepath: ["+path+ "] => "+dataset[id].a+", "+dataset[id].b)
                if( ! (id in selectedCandidates) )
                        selectedCandidates.push(id)
                        
                if( dataset[id].a == 'None'){
                        return ;
                }
                console.log(id+": apath:  => "+dataset[id].a)
                
                setLinkState(id, dataset[id].a, state, dataset[id].type)
                changeParent(dataset[id].a, state, path.concat([dataset[id].a]))
                
                if( dataset[id].b == 'None'){
                        return ;
                }
                console.log(id+": bpath: "+dataset[id].b)
                
                setLinkState(id, dataset[id].b, state)    
                changeParent(dataset[id].b, state, path.concat([dataset[id].b]), dataset[id].type)
        }
       
        function mouseclick(d){
                window.open( "../generation"+d.gen+"/index.html", "_self")
        }
       
        function mouseover(d) {
               console.log("========================")
               //changeParent(d.id, false,[d.id])
               svg.selectAll("image").remove()
               svg.selectAll(".hoverlinks").remove()
                
               selectedCandidates=[]
               selectedLinks=[]
               
               changeParent(d.id, true,[d.id]) 
               console.log("SELECTED CANDIDATES: ["+selectedCandidates+"]")
               console.log("SELECTED LINKS: ["+selectedLinks+"]")
               makLinks(selectedLinks)
               makimg(selectedCandidates)
        }       

        function mouseout(d) {
                
        }
        
});

</script>

</body>


