<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node circle {
  fill: #999;
}

.node text {
  font: 10px sans-serif;
}

.node--internal circle {
  fill: #555;
}

.node--internal text {
  text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
}

.link {
  fill: none;
  stroke: #555;
  stroke-opacity: 0.4;
  stroke-width: 1.5px;
}

div.candidate {
    display: inline-block;
    width: 50px;
    height: 20px;   /* We'll override this later */
    background-color: teal;
    margin-right: 2px;
    text-align: center;
}

.link {
  fill: none;
  stroke: #555;
  stroke-opacity: 0.1;
  stroke-width: 1.5px;
}

.link.source {
  stroke-width: 4.0px;
  stroke-opacity: 1.0;
  fill: #900;
  background-color: teal;
  fill: teal; 
}

.title
{
        font: 40px sans-serif;
}

.desc
{
        font: 15px sans-serif;
}

</style>
<body>

<div class='title'>History view</div>
<br>
<hr>
<div class='desc'>
In a single view we display all the candidates that appears during a run of the algorithm. <br>
They are ordered according to their "birthdate". <br>
The color is representing the generation. It is possible to visualize the parent of a candidate by 
putting the mouse over. <br>
</div>
<hr>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
// This function randomColor has been cut&pasted from somewhere...forgot its author. 
// If you know him please contact me to add proper credits here. 
var randomColor = (function(){
var golden_ratio_conjugate = 0.618033988749895;
var h = Math.random();
var hslToRgb = function (h, s, l){
var r, g, b;
if(s == 0){
r = g = b = l; // achromatic
}else{
function hue2rgb(p, q, t){
if(t < 0) t += 1;
if(t > 1) t -= 1;
if(t < 1/6) return p + (q - p) * 6 * t;
if(t < 1/2) return q;
if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
return p;
}
var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
var p = 2 * l - q;
r = hue2rgb(p, q, h + 1/3);
g = hue2rgb(p, q, h);
b = hue2rgb(p, q, h - 1/3);
}
return '#'+Math.round(r * 255).toString(16)+Math.round(g * 255).toString(16)+Math.round(b * 255).toString(16);
};
return function(){
h += golden_ratio_conjugate;
h %= 1;
return hslToRgb(h, 0.5, 0.60);
};
})();

d3.csv("history.csv", function(dataset) {
        var posdatax={}
        var posdatay={}
        var colorset = {}
        var gensize = {}
        var genbegin = {}
        var genarray = []
        dataset.forEach(function(d) {
                colorset[d.gen] = randomColor() 
                genbegin[d.gen] = 1000000000
                if(d.gen in gensize){
                        gensize[d.gen] = 0
                        genarray[d.gen] += 1 
                }else{
                        gensize[d.gen] = 0
                        genarray.push(1) 
                }
        })
       
        var boxw = 50;
        var boxh = 20;
        var h = 500;
        
        var svgleft = d3.select("body")
                        .append("svg")
                        //.attr("width", 60)
                        .attr("height", 2048)
                        .attr("style", "float: left; width: 5%; margin-right: 1%; margin-bottom: 0.5em;")

        var genrects = svgleft.selectAll("rect")
                              .data(genarray)
                              .enter()
                              .append("rect");

        var lastpath = []
                              
        var svg = d3.select("body")
                    .append("svg")
                    .attr("height", 2048)
                    .attr("style", "float: left; width: 93%; margin-right: 1%; margin-bottom: 0.5em;")
                    
        d3.select("body")
                .append("p")
                .attr("style", "clear: both;")

        var rects = svg.selectAll("rect")
                .data(dataset)
                .enter()
                .append("rect");
    
        rects.attr("x",    function(d,i){ 
                        var val = (i%30)*(boxw+1)
                        posdatax[d.id] = val 
                        return val }
                    )
                .attr("y", function(d,i){ 
                        var val = Math.floor((i/30))*(boxh+10)
                        if(val>gensize[d.gen]){
                                gensize[d.gen]=val
                        }
                        if(val<genbegin[d.gen]){
                                genbegin[d.gen]=val
                        }
                        posdatay[d.id] = val 
                        return val })
                .attr("width", boxw)
                .attr("height", boxh)
                .attr("fill", function(d,i){return colorset[d.gen] }) 
                .on("mouseenter", mouseover)
                .on("mouseleave", mouseout)
                .on("click", mouseclick)
                .attr("id", function(d){return d.id;} )

          genrects.attr("x",    function(d,i){ return 0 })
                .attr("y",      function(d,i){ return genbegin[i]+30 })
                .attr("width", 60)
                .attr("height", function(d,i){ return gensize[i]-genbegin[i]})
                .attr("fill", function(d,i){return colorset[i] }) 
                
          svgleft.selectAll("text")
                .data(genarray)
                .enter()
                .append("text")
                .text(function(d,i) { return i })
                .attr("x", function(d, i) { return 25 ;})
                .attr("y", function(d,i){ return 0.5*(gensize[i]+genbegin[i]+60) })
                .attr("font-family", "sans-serif")
                .attr("font-size", "15px")
                .attr("fill", "white")
                .attr("font-weight", "bold")
                .attr("text-anchor", "middle")
               
                

        svg.selectAll("text")
                .data(dataset)
                .enter()
                .append("text")
                .text(function(d) { return d.id })
                .attr("x", function(d, i) {
                        return (i%30)*(boxw+1) + boxw/2 ;
                })
                .attr("y", function(d,i){ return Math.floor((i/30))*(boxh+10)+15 })
                .attr("font-family", "sans-serif")
                .attr("font-size", "12px")
                .attr("fill", "white")
                .attr("font-weight", "bold")
                .attr("text-anchor", "middle")
                .on("mouseenter", mouseover)
                .on("mouseleave", mouseout)
                .on("click", mouseclick)
                
       var link = svg.selectAll(".link")
        .data(dataset)
        .enter().append("path")
        .attr("class", "link")
        .attr("id",function(d, i){ return "node-"+d.id;}) 
        .attr("d", function(d, i) {
                if(d.a == 'None')
                        return "";
                
                var x = (i%30)*(boxw+1)+boxw/2
                var y = Math.floor((i/30))*(boxh+10)
                var tx = (d.a%30)*(boxw+1)+boxw/2
                var ty = Math.floor((d.a/30))*(boxh+10)+boxh
                return "M" + [x,y]
                        + "L" + [tx,ty];
        });
        
        function makimg(datapath){
                 var img = svg.selectAll("image")
                                    .data(lastpath)
                                    .enter()
                                    .append("image")
                                    .attr("width", 64)
                                    .attr("height", 64)
                                    .attr("xlink:href", function(d,i){ return "../generation"+dataset[d].gen+"/candidate"+d+".png"})
                                    .attr("x", function(d,i){ 
                                                if(i>0)
                                                                return posdatax[d]
                                                              return posdatax[d]-60 
                                                               })
                                    .attr("y", function(d,i){ 
                                        return posdatay[d] }
                                        )
        }
        
        function changeParent(id,state){
                lastpath.push(id)           
                
                if(state){
                        svg.select("#node-" + id)
                              .transition()
                              .duration(0)
                              .style("stroke-opacity", "1")
                              .style("stroke-width", "4px")
                }else{
                        svg.select("#node-" + id)
                              .transition()
                              .duration(0)
                              .style("stroke-opacity", "0.1")
                              .style("stroke-width", "1px")
                }
                   
                if( dataset[id].a == 'None'){
                        makimg(lastpath)
                        lastpath=[]
                        return ;
                }
                changeParent(dataset[id].a, state)
        }
       
        function mouseclick(d){
                window.open( "../generation"+d.gen+"/index.html", "_self")
        }
       
        function mouseover(d) {
               changeParent(d.id, true) 
               console.log("ADDED IMAGE")
        }       

        function mouseout(d) {
                svg.selectAll("image").remove()
                console.log("REMOVE IMAGE")
                changeParent(d.id, false)
        }
        
});

</script>

</body>


