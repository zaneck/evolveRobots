import Sofa

import topo
from tools import *


def createScene(rootNode):

                rootNode.createObject('RequiredPlugin', pluginName='SoftRobots')
                rootNode.createObject('VisualStyle', displayFlags='showVisualModels hideBehaviorModels showCollisionModels hideBoundingCollisionModels showForceFields showInteractionForceFields hideWireframe')

                rootNode.findData("gravity").value = "0 -9810 0"

                rootNode.createObject('BackgroundSetting', color='0 0.168627 0.211765')

                rootNode.createObject('FreeMotionAnimationLoop')
                rootNode.createObject('GenericConstraintSolver')
                rootNode.createObject('CollisionPipeline', verbose="0")
                rootNode.createObject('BruteForceDetection', name="N2")
                rootNode.createObject('CollisionResponse', response="FrictionContact", responseParams="mu=0")
                rootNode.createObject('LocalMinDistance', name="Proximity", alarmDistance="2", contactDistance="1")
                
                ##########################################
                # Obstacle                               #
                ##########################################
                obstacle = rootNode.createChild('obstacle')
                obstacle.createObject('EulerImplicit', firstOrder='1')
                obstacle.createObject('CGLinearSolver', iterations='100')
                obstacle.createObject('MechanicalObject', position='25  42.5  2.5')
                obstacle.createObject('Sphere', radius='5', group='2')
                obstacle.createObject('UncoupledConstraintCorrection')

                ##########################################
                # FEM Model                              
                ##########################################
                sizeX, sizeY, sizeZ = 50, 50, 5
                x , y , z = 21, 21, 2

                object = rootNode.createChild('object')
                object.createObject('EulerImplicit', name='odesolver', firstOrder='0')
                object.createObject('CGLinearSolver')
                grid = object.createObject('RegularGridTopology', name= 'grid', n="{0} {1} {2}".format(x, y, z), max="{0} {1} {2}".format(sizeX, sizeY, sizeZ), min="0 0 0")
                hexa = grid.findData('hexahedra').value

                object.createObject('MechanicalObject', name='tetras', template='Vec3d', showIndices='false', showIndicesScale='4e-5', rx='0', dz='0')
                object.createObject('UniformMass', totalmass='0.02')
                object.createObject('PartialFixedConstraint', fixedDirections='0 0 1', fixAll="true")
                
                object.createObject('BoxROI', name='ROI1', box='0 0 0 5 2.5 5', drawBoxes='true')
                object.createObject('FixedConstraint', indices='@ROI1.indices')
                
                object.createObject('BoxROI', name='ROI2', box='45 0 0 50 2.5 5', drawBoxes='true')
                object.createObject('FixedConstraint', indices='@ROI2.indices')
                
                object.createObject('BoxROI', name='ROI3', box='22.5 0 0 27.5 2.5 5', drawBoxes='true')
                object.createObject('ConstantForceField', force='0 -25 0', points='@ROI3.indices')

                object.createObject('BoxROI', name='LEFTBOX', box='0 47.5 0 5 50 5', drawBoxes='true')
                object.createObject('BoxROI', name='RIGHTBOX', box='45 47.5 0 50 50 5', drawBoxes='true')

                object.createObject('UncoupledConstraintCorrection')                
                ##########################################
                # Subtopology for Force Field            
                ##########################################
                mask = matrixImageToMask(topo.topology, x-1, y-1)
                hexaStr = tabToString(hexa, mask)

                subTopo = object.createChild('subTopo')
                subTopo.createObject('HexahedronSetTopologyContainer', name='HexahedronSetTopologyContainer', position='@../grid.position', hexahedra=hexaStr)
                subTopo.createObject('HexahedronFEMForceField', template='Vec3d', name='FEM', method='large', poissonRatio='0.3',  youngModulus='500')
                
                ##########################################
                # Contact                                #
                ##########################################
                objectContact = object.createChild('contact')
                #points cool uniquement
                objectContact.createObject('Mesh', src='@/object/subTopo')
                #objectContact.createObject('Mesh', hexahedra=hexaStr )
                objectContact.createObject('MechanicalObject')
                objectContact.createObject('TTriangleModel', group="0")
                objectContact.createObject('TLineModel', group="0")
                #objectContact.createObject('TPointModel', group="0")
                objectContact.createObject('BarycentricMapping')

                ##########################################
                # Controller                             
                ##########################################
                object.createObject('PythonScriptController', filename="controller.py", classname="controller")
                
                return rootNode

